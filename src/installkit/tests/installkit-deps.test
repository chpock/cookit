# installkit tests - check binary dependencies
#
# Copyright (C) 2024 Konstantin Kushnir <chpock@gmail.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

if { [lsearch [namespace children] ::tcltest] == -1 } {
    package require tcltest 2
    namespace import -force ::tcltest::*
}

source [file join [tcltest::testsDirectory] helper.tcl]

set platform [lindex [file split [info nameofexecutable]] end-2]

# Known platforms:
#   Linux-x86
#   Linux-x86_64
#   MacOS-X
#   Windows

set expected [dict create {*}{
    Linux-x86 {
        installkit-deps {
            installkit_raw {
                /lib/ld-linux.so.2
                libc.so.6
                libdl.so.2
                libm.so.6
                libpthread.so.0
                linux-gate.so.1
            }
            libtk*.so {
                /lib/ld-linux.so.2
                libX11.so.6
                libXau.so.6
                libc.so.6
                libdl.so.2
                libm.so.6
                libxcb.so.1
                linux-gate.so.1
            }
        }
        installkit-glibc {
            installkit_raw { 2.11 2.7 2.3.4 2.3.2 2.3 2.2 2.1 2.0 }
            libtk*.so      { 2.7 2.3 2.1.3 2.1 2.0 }
        }
        libs-deps {
            libTktable*.so {
                /lib/ld-linux.so.2
                libX11.so.6
                libXau.so.6
                libc.so.6
                libdl.so.2
                libxcb.so.1
                linux-gate.so.1
            }
            libtkdnd*.so {
                /lib/ld-linux.so.2
                libX11.so.6
                libXau.so.6
                libXcursor.so.1
                libXfixes.so.3
                libXrender.so.1
                libc.so.6
                libdl.so.2
                libxcb.so.1
                linux-gate.so.1
             }
        }
        libs-glibc {
            libTktable*.so { 2.7 2.3 2.1.3 2.0 }
            libtkdnd*.so   { 2.1.3 2.0 }
        }
    }
    Linux-x86_64 {
        installkit-deps {
            installkit_raw {
                /lib64/ld-linux-x86-64.so.2
                libc.so.6
                libdl.so.2
                libm.so.6
                libpthread.so.0
                linux-vdso.so.1
            }
            libtk*.so {
                /lib64/ld-linux-x86-64.so.2
                libX11.so.6
                libXau.so.6
                libc.so.6
                libdl.so.2
                libm.so.6
                libxcb.so.1
                linux-vdso.so.1
            }
        }
        installkit-glibc {
            installkit_raw { 2.11 2.7 2.3.4 2.3.2 2.3 2.2.5 }
            libtk*.so      { 2.7 2.3 2.2.5 }
        }
        libs-deps {
            libTktable*.so {
                /lib64/ld-linux-x86-64.so.2
                libX11.so.6
                libXau.so.6
                libc.so.6
                libdl.so.2
                libxcb.so.1
                linux-vdso.so.1
            }
            libtkdnd*.so {
                /lib64/ld-linux-x86-64.so.2
                libX11.so.6
                libXau.so.6
                libXcursor.so.1
                libXfixes.so.3
                libXrender.so.1
                libc.so.6
                libdl.so.2
                libxcb.so.1
                linux-vdso.so.1
            }
        }
        libs-glibc {
            libTktable*.so { 2.7 2.3 2.2.5 }
            libtkdnd*.so   { 2.2.5 }
        }
    }
    MacOS-X {
        installkit-deps {
            installkit_raw {
                /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation
                /usr/lib/libSystem.B.dylib
            }
            libtk*.dylib   {
                /System/Library/Frameworks/AppKit.framework/Versions/C/AppKit
                /System/Library/Frameworks/ApplicationServices.framework/Versions/A/ApplicationServices
                /System/Library/Frameworks/Carbon.framework/Versions/A/Carbon
                /System/Library/Frameworks/Cocoa.framework/Versions/A/Cocoa
                /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation
                /System/Library/Frameworks/CoreServices.framework/Versions/A/CoreServices
                /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation
                /System/Library/Frameworks/IOKit.framework/Versions/A/IOKit
                /System/Library/Frameworks/QuartzCore.framework/Versions/A/QuartzCore
                /usr/lib/libSystem.B.dylib
                /usr/lib/libobjc.A.dylib
            }
        }
        libs-deps {
            libTktable*.dylib {
                /usr/lib/libSystem.B.dylib
            }
            libtkdnd*.dylib {
                /System/Library/Frameworks/AppKit.framework/Versions/C/AppKit
                /System/Library/Frameworks/Carbon.framework/Versions/A/Carbon
                /System/Library/Frameworks/Cocoa.framework/Versions/A/Cocoa
                /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation
                /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation
                /usr/lib/libSystem.B.dylib
                /usr/lib/libobjc.A.dylib
            }
        }
    }
    Windows {
        installkit-deps {
            installkit_raw.exe {
                ADVAPI32.dll
                COMCTL32.DLL
                COMDLG32.DLL
                CRYPT32.dll
                GDI32.dll
                IMM32.DLL
                IPHLPAPI.DLL
                KERNEL32.dll
                MPR.DLL
                NETAPI32.dll
                OLEAUT32.dll
                POWRPROF.dll
                PSAPI.DLL
                RPCRT4.dll
                SETUPAPI.dll
                SHELL32.dll
                Secur32.dll
                USER32.dll
                USERENV.dll
                UxTheme.dll
                VERSION.dll
                WINMM.DLL
                WINSPOOL.DRV
                WINTRUST.dll
                WS2_32.dll
                WTSAPI32.dll
                credui.dll
                msvcrt.dll
                ole32.dll
                pdh.dll
            }
        }
        libs-deps {
            Tktable*.dll {
                KERNEL32.dll
                msvcrt.dll
            }
            tkdnd*.dll {
                KERNEL32.dll
                SHELL32.dll
                USER32.dll
                msvcrt.dll
                ole32.dll
            }
        }
    }
}]

set setup_load_deps [list apply {{ file {var deps} } {
    upvar 1 $var deps
    set deps [dict create]
    set fp [open [file join [file dirname [info nameofexecutable]] .. $file] r]
    while { [gets $fp line] != -1 } {
        set line [split $line " "]
        dict set deps [lindex $line 0] [lindex $line 1] [join [lrange $line 2 end] " "]
    }
    close $fp
}}]

set expected [list apply {{ platform expected type } {
    if { ![dict exists $expected $platform $type] } { return "" }
    set result [list]
    dict for { k v } [dict get $expected $platform $type] {
        lappend result "$k [join $v { }]"
    }
    return [join $result \n]
}} $platform $expected]

test installkit-deps-installkit-deps {installkit dependencies} -setup [concat \
    $setup_load_deps \
    installkit-deps.txt \
] -body {
    set result [list]
    dict for { exe data } $deps {
        dict for { type data } $data {
            if { $type ne "DEPS" } continue
            lappend result "$exe $data"
        }
    }
    join $result \n
} -match glob -result [{*}$expected installkit-deps] -cleanup {
    unset deps
}

test installkit-deps-installkit-glibc {installkit GLIBC requirement} -constraints linuxOnly -setup [concat \
    $setup_load_deps \
    installkit-deps.txt \
] -body {
    set result [list]
    dict for { exe data } $deps {
        dict for { type data } $data {
            if { $type ne "GLIBC" } continue
            lappend result "$exe $data"
        }
    }
    join $result \n
} -match glob -result [{*}$expected installkit-glibc] -cleanup {
    unset deps
}

test installkit-deps-installkit-rpath {installkit RPATH} -constraints unix -setup [concat \
    $setup_load_deps \
    installkit-deps.txt \
] -body {
    set result [list]
    dict for { exe data } $deps {
        dict for { type data } $data {
            if { $type ne "RPATH" } continue
            if { $data eq "None" } continue
            lappend result "$exe $data"
        }
    }
    join $result \n
} -match glob -result "" -cleanup {
    unset deps
}

test installkit-deps-libs-deps {other packages dependencies} -setup [concat \
    $setup_load_deps \
    libs-deps.txt \
] -body {
    set result [list]
    dict for { exe data } $deps {
        dict for { type data } $data {
            if { $type ne "DEPS" } continue
            lappend result "$exe $data"
        }
    }
    join $result \n
} -match glob -result [{*}$expected libs-deps] -cleanup {
    unset deps
}

test installkit-deps-libs-glibc {other packages GLIBC requirements} -constraints linuxOnly -setup [concat \
    $setup_load_deps \
    libs-deps.txt \
] -body {
    set result [list]
    dict for { exe data } $deps {
        dict for { type data } $data {
            if { $type ne "GLIBC" } continue
            lappend result "$exe $data"
        }
    }
    join $result \n
} -match glob -result [{*}$expected libs-glibc] -cleanup {
    unset deps
}

test installkit-deps-libs-rpath {other packages RPATH} -constraints unix -setup [concat \
    $setup_load_deps \
    libs-deps.txt \
] -body {
    set result [list]
    dict for { exe data } $deps {
        dict for { type data } $data {
            if { $type ne "RPATH" } continue
            if { $data eq "None" } continue
            lappend result "$exe $data"
        }
    }
    join $result \n
} -match glob -result "" -cleanup {
    unset deps
}

# cleanup
::tcltest::cleanupTests
return
