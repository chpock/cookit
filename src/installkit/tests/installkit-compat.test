# installkit tests - installkit::compat package
#
# Copyright (C) 2024 Konstantin Kushnir <chpock@gmail.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

if { [lsearch [namespace children] ::tcltest] == -1 } {
    package require tcltest 2
    namespace import -force ::tcltest::*
}

source [file join [tcltest::testsDirectory] helper.tcl]

test installkit::compat-basic-1.1 {test that installkit::compat is not loaded by default} -body {
    package present installkit::compat
} -returnCodes error -result {package installkit::compat is not present}

test installkit::compat-basic-1.2 {test that sha1hex proc is not defined by default} -body {
    info commands sha1hex
} -result {}

# load installkit::compat
namespace eval ::InstallJammer {}

test installkit::compat-basic-1.3 {test that installkit::compat is loaded} -body {
    package present installkit::compat
} -match glob -result *

test installkit::compat-basic-1.4 {test that sha1hex proc is defined} -body {
    info commands sha1hex
} -result {sha1hex}

# It is not real sha1 hash. This is a string computed from an MD5 hash.
test installkit::compat-sha1-1 {sha1 proc with empty data} -body {
    sha1hex ""
} -result D41D8CD98F00B204E9800998ECF8427ED41D8CD9

# It is not real sha1 hash. This is a string computed from an MD5 hash.
test installkit::compat-sha1-2 {sha1 proc with simple data} -body {
    sha1hex "a"
} -result 0CC175B9C0F1B6A831C399E2697726610CC175B9

test installkit::compat-crapvfs-1 {mount/unmount} -body {
    set mnt [::installkit::tmpmount]
    ::crapvfs::mount [info nameofexecutable] $mnt
    ::crapvfs::unmount $mnt
    set ok ok
} -result ok

test installkit::compat-crapvfs-2 {setPassword} -body {
    ::crapvfs::setPassword foo
    set ok ok
} -result ok

test installkit::compat-win-1 {check for twapi::builtin_account_sids array} -constraints win -body {
    lsort [array names ::twapi::builtin_account_sids]
} -result [list administrators guests {power users} users]

# cleanup
::tcltest::cleanupTests
return
